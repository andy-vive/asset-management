<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i S·∫£n</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #1f2937;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-gold: #fbbf24;
            --accent-gold-dark: #d97706;
            --accent-emerald: #10b981;
            --accent-rose: #f43f5e;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --border-color: #374151;
            --gradient-gold: linear-gradient(135deg, #fbbf24, #f59e0b);
            --gradient-emerald: linear-gradient(135deg, #10b981, #059669);
            --gradient-rose: linear-gradient(135deg, #f43f5e, #e11d48);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow-gold: 0 0 40px rgba(251, 191, 36, 0.15);
            --shadow-glow-emerald: 0 0 40px rgba(16, 185, 129, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-gold);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-primary {
            background: var(--gradient-gold);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-gold);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: var(--gradient-emerald);
            color: #fff;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-emerald);
        }

        /* Main Content */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .summary-card.gold::before {
            background: var(--gradient-gold);
        }

        .summary-card.profit::before {
            background: var(--gradient-emerald);
        }

        .summary-card.loss::before {
            background: var(--gradient-rose);
        }

        .summary-card.neutral::before {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .summary-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .summary-change.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-emerald);
        }

        .summary-change.negative {
            background: rgba(244, 63, 94, 0.15);
            color: var(--accent-rose);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Tables */
        .table-section {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .table-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem 1.25rem;
            text-align: left;
        }

        th {
            background: var(--bg-secondary);
            font-weight: 500;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        td {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--bg-card-hover);
        }

        .stock-name {
            font-family: 'Be Vietnam Pro', sans-serif;
            font-weight: 500;
        }

        .stock-code {
            font-weight: 600;
            color: var(--accent-gold);
        }

        .stock-company {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .positive {
            color: var(--accent-emerald);
        }

        .negative {
            color: var(--accent-rose);
        }

        .neutral-text {
            color: var(--text-secondary);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-gold {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-gold);
        }

        .badge-blue {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
        }

        .badge-cyan {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
        }

        /* Action buttons in table */
        .action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.375rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .action-btn.delete:hover {
            color: var(--accent-rose);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: var(--text-secondary);
            border: none;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .tab.active {
            background: var(--gradient-gold);
            color: #000;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0.25rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* File input */
        .file-input-wrapper {
            position: relative;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-wrapper:hover {
            border-color: var(--accent-gold);
            background: rgba(251, 191, 36, 0.05);
        }

        .file-input-wrapper input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .file-input-text {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        /* Monthly Returns */
        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }

        .month-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .month-name {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .month-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-subtext {
            font-size: 0.875rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1100;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--accent-emerald);
        }

        .toast.error {
            border-left: 4px solid var(--accent-rose);
        }

        /* Legend */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }

        /* Market Prices Bar */
        .market-prices-bar {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .market-prices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .market-prices-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .market-prices-updated {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .market-prices-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .market-price-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 10px;
            min-width: 200px;
        }

        .market-price-icon {
            font-size: 1.5rem;
        }

        .market-price-info {
            flex: 1;
        }

        .market-price-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .market-price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
        }

        .market-price-unit {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üí∞</div>
                <span class="logo-text">Qu·∫£n L√Ω T√†i S·∫£n</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openMarketPriceModal()">
                    üíπ Gi√° th·ªã tr∆∞·ªùng
                </button>
                <button class="btn btn-secondary" onclick="exportCSV()">
                    üì• Xu·∫•t CSV
                </button>
                <label class="btn btn-secondary" style="cursor: pointer;">
                    üì§ Nh·∫≠p CSV
                    <input type="file" accept=".csv" onchange="importCSV(event)" style="display: none;">
                </label>
                <button class="btn btn-primary" onclick="openAddModal()">
                    ‚ûï Th√™m t√†i s·∫£n
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card gold animate-in">
                <div class="summary-label">T·ªïng gi√° tr·ªã t√†i s·∫£n</div>
                <div class="summary-value" id="total-value">0 ‚Ç´</div>
            </div>
            <div class="summary-card neutral animate-in delay-1">
                <div class="summary-label">T·ªïng gi√° v·ªën</div>
                <div class="summary-value" id="total-cost">0 ‚Ç´</div>
            </div>
            <div class="summary-card profit animate-in delay-2" id="profit-card">
                <div class="summary-label">T·ªïng l·ª£i nhu·∫≠n</div>
                <div class="summary-value" id="total-profit">0 ‚Ç´</div>
                <div class="summary-change positive" id="profit-percent">
                    <span>‚Üë</span> 0%
                </div>
            </div>
        </div>

        <!-- Market Prices Bar -->
        <div class="market-prices-bar animate-in delay-1">
            <div class="market-prices-header">
                <span class="market-prices-title">üíπ Gi√° th·ªã tr∆∞·ªùng</span>
                <span class="market-prices-updated" id="prices-updated-time"></span>
            </div>
            <div class="market-prices-grid" id="market-prices-display">
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-section">
            <div class="chart-card animate-in delay-2">
                <h3 class="chart-title">üìä Ph√¢n b·ªï t√†i s·∫£n</h3>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
                <div class="chart-legend" id="allocation-legend"></div>
            </div>
            <div class="chart-card animate-in delay-3">
                <h3 class="chart-title">üìà T·ª∑ tr·ªçng danh m·ª•c c·ªï phi·∫øu</h3>
                <div class="chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
                <div class="chart-legend" id="stock-legend"></div>
            </div>
        </div>

        <!-- Stock Portfolio -->
        <div class="table-section animate-in delay-3">
            <div class="table-header">
                <h3 class="table-title">üìã Danh s√°ch c·ªï phi·∫øu trong danh m·ª•c</h3>
                <button class="btn btn-primary" onclick="openAddModal('stock')">
                    ‚ûï Th√™m c·ªï phi·∫øu
                </button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ CK</th>
                            <th>T·ª∑ tr·ªçng</th>
                            <th>Kh·ªëi l∆∞·ª£ng</th>
                            <th>Gi√° v·ªën</th>
                            <th>Gi√° th·ªã tr∆∞·ªùng</th>
                            <th>Gi√° tr·ªã v·ªën</th>
                            <th>Gi√° tr·ªã hi·ªán t·∫°i</th>
                            <th>L·ª£i nhu·∫≠n</th>
                            <th>%</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="stock-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Other Assets -->
        <div class="table-section animate-in delay-4">
            <div class="table-header">
                <h3 class="table-title">üíé T√†i s·∫£n kh√°c</h3>
                <button class="btn btn-primary" onclick="openAddModal('other')">
                    ‚ûï Th√™m t√†i s·∫£n
                </button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Lo·∫°i t√†i s·∫£n</th>
                            <th>T·ª∑ tr·ªçng</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>ƒê∆°n v·ªã</th>
                            <th>Gi√° v·ªën</th>
                            <th>Gi√° hi·ªán t·∫°i</th>
                            <th>Gi√° tr·ªã v·ªën</th>
                            <th>Gi√° tr·ªã hi·ªán t·∫°i</th>
                            <th>L√£i/L·ªó</th>
                            <th>%</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="other-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Monthly Returns -->
        <div class="table-section animate-in">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(this, 'monthly')">üìÖ L·ª£i nhu·∫≠n theo th√°ng</button>
                <button class="tab" onclick="switchTab(this, 'performance')">üìä Hi·ªáu qu·∫£ theo lo·∫°i t√†i s·∫£n</button>
                <button class="tab" onclick="switchTab(this, 'history')">üìú L·ªãch s·ª≠ giao d·ªãch</button>
            </div>
            <div id="monthly-content">
                <div class="table-header">
                    <h3 class="table-title">T·ª∑ su·∫•t l·ª£i nhu·∫≠n nƒÉm 2025</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="form-select" style="width: auto;" id="year-select" onchange="updateMonthlyView()">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                        <button class="btn btn-secondary" onclick="openMonthlyModal()">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
                    </div>
                </div>
                <div class="monthly-grid" id="monthly-grid">
                </div>
            </div>
            <div id="history-content" style="display: none;">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>Lo·∫°i</th>
                                <th>T√†i s·∫£n</th>
                                <th>H√†nh ƒë·ªông</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Gi√°</th>
                                <th>T·ªïng</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="performance-content" style="display: none;">
                <div class="table-header">
                    <h3 class="table-title">Hi·ªáu qu·∫£ ƒë·∫ßu t∆∞ theo lo·∫°i t√†i s·∫£n</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="form-select" style="width: auto;" id="perf-year-select" onchange="renderPerformanceView()">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                        <button class="btn btn-primary" onclick="openSnapshotModal()">üì∏ Ch·ªët gi√° tr·ªã th√°ng</button>
                    </div>
                </div>
                <div style="padding: 0 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                        üí° Nh·∫•n "Ch·ªët gi√° tr·ªã th√°ng" v√†o cu·ªëi m·ªói th√°ng ƒë·ªÉ l∆∞u gi√° tr·ªã t√†i s·∫£n. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh % l·ª£i nhu·∫≠n.
                    </p>
                </div>
                <div class="table-wrapper">
                    <table id="performance-table">
                        <thead>
                            <tr>
                                <th>Lo·∫°i t√†i s·∫£n</th>
                                <th>T1</th>
                                <th>T2</th>
                                <th>T3</th>
                                <th>T4</th>
                                <th>T5</th>
                                <th>T6</th>
                                <th>T7</th>
                                <th>T8</th>
                                <th>T9</th>
                                <th>T10</th>
                                <th>T11</th>
                                <th>T12</th>
                                <th>C·∫£ nƒÉm</th>
                            </tr>
                        </thead>
                        <tbody id="performance-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="chart-card" style="margin: 1.5rem;">
                    <h3 class="chart-title">üìà Bi·ªÉu ƒë·ªì hi·ªáu qu·∫£ ƒë·∫ßu t∆∞ theo th√°ng</h3>
                    <div style="height: 350px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                <div class="table-section" style="margin: 1.5rem;">
                    <div class="table-header">
                        <h3 class="table-title">üìã L·ªãch s·ª≠ ch·ªët gi√° tr·ªã</h3>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Th√°ng</th>
                                    <th>C·ªï phi·∫øu</th>
                                    <th>V√†ng nh·∫´n</th>
                                    <th>V√†ng SJC</th>
                                    <th>PAXG</th>
                                    <th>USDT</th>
                                    <th>Ti·∫øt ki·ªám</th>
                                    <th>T·ªïng</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="snapshot-history-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Asset Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Th√™m t√†i s·∫£n m·ªõi</h3>
                <button class="modal-close" onclick="closeModal('add-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Lo·∫°i t√†i s·∫£n</label>
                        <select class="form-select" id="asset-type" onchange="toggleAssetFields()">
                            <option value="stock">C·ªï phi·∫øu</option>
                            <option value="gold">V√†ng nh·∫´n/mi·∫øng</option>
                            <option value="gold_sjc">V√†ng SJC</option>
                            <option value="paxg">V√†ng PAXG</option>
                            <option value="usdt">USDT</option>
                            <option value="savings">Ti·∫øt ki·ªám</option>
                            <option value="other">Kh√°c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ng√†y giao d·ªãch</label>
                        <input type="date" class="form-input" id="transaction-date">
                    </div>
                </div>
                
                <!-- Stock Fields -->
                <div id="stock-fields">
                    <div class="form-group">
                        <label class="form-label">M√£ ch·ª©ng kho√°n</label>
                        <input type="text" class="form-input" id="stock-code" placeholder="VD: FPT, VNM, VIC...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√™n c√¥ng ty (tu·ª≥ ch·ªçn)</label>
                        <input type="text" class="form-input" id="stock-company" placeholder="VD: CTCP FPT">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Kh·ªëi l∆∞·ª£ng</label>
                            <input type="number" class="form-input" id="stock-quantity" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gi√° v·ªën (VNƒê)</label>
                            <input type="number" class="form-input" id="stock-cost" placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gi√° th·ªã tr∆∞·ªùng (VNƒê)</label>
                        <input type="number" class="form-input" id="stock-market" placeholder="0">
                    </div>
                </div>

                <!-- Other Asset Fields -->
                <div id="other-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">T√™n t√†i s·∫£n</label>
                        <input type="text" class="form-input" id="asset-name" placeholder="VD: V√†ng nh·∫´n 9999">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">S·ªë l∆∞·ª£ng</label>
                            <input type="number" step="0.01" class="form-input" id="asset-quantity" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ƒê∆°n v·ªã</label>
                            <input type="text" class="form-input" id="asset-unit" placeholder="L∆∞·ª£ng, PAXG, USDT...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Gi√° v·ªën / ƒë∆°n v·ªã</label>
                            <input type="number" class="form-input" id="asset-cost" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gi√° hi·ªán t·∫°i / ƒë∆°n v·ªã</label>
                            <input type="number" class="form-input" id="asset-price" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Savings Fields -->
                <div id="savings-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">T√™n kho·∫£n ti·∫øt ki·ªám</label>
                        <input type="text" class="form-input" id="savings-name" placeholder="VD: Ti·∫øt ki·ªám ng√¢n h√†ng X">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">S·ªë ti·ªÅn g·ª≠i (VNƒê)</label>
                            <input type="number" class="form-input" id="savings-amount" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">L√£i su·∫•t (%/nƒÉm)</label>
                            <input type="number" step="0.01" class="form-input" id="savings-rate" placeholder="5.5">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-modal')">Hu·ª∑</button>
                <button class="btn btn-success" onclick="saveAsset()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Monthly Edit Modal -->
    <div class="modal-overlay" id="monthly-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ch·ªânh s·ª≠a l·ª£i nhu·∫≠n th√°ng</h3>
                <button class="modal-close" onclick="closeModal('monthly-modal')">&times;</button>
            </div>
            <div class="modal-body" id="monthly-edit-body">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('monthly-modal')">Hu·ª∑</button>
                <button class="btn btn-success" onclick="saveMonthlyReturns()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Edit Asset Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ch·ªânh s·ª≠a t√†i s·∫£n</h3>
                <button class="modal-close" onclick="closeModal('edit-modal')">&times;</button>
            </div>
            <div class="modal-body" id="edit-modal-body">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-modal')">Hu·ª∑</button>
                <button class="btn btn-success" id="edit-save-btn">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Snapshot Modal -->
    <div class="modal-overlay" id="snapshot-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">üì∏ Ch·ªët gi√° tr·ªã t√†i s·∫£n</h3>
                <button class="modal-close" onclick="closeModal('snapshot-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ch·ªçn th√°ng</label>
                        <input type="month" class="form-input" id="snapshot-month">
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary" onclick="loadCurrentValues()" style="width: 100%;">üîÑ L·∫•y gi√° tr·ªã hi·ªán t·∫°i</button>
                    </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                    Nh·∫≠p gi√° tr·ªã t√†i s·∫£n v√†o cu·ªëi th√°ng ƒë∆∞·ª£c ch·ªçn. H·ªá th·ªëng s·∫Ω t√≠nh % l·ª£i nhu·∫≠n so v·ªõi th√°ng tr∆∞·ªõc.
                </p>
                <div id="snapshot-fields"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('snapshot-modal')">Hu·ª∑</button>
                <button class="btn btn-success" onclick="saveSnapshot()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Market Price Modal -->
    <div class="modal-overlay" id="market-price-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üíπ C·∫≠p nh·∫≠t gi√° th·ªã tr∆∞·ªùng</h3>
                <button class="modal-close" onclick="closeModal('market-price-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
                    C·∫≠p nh·∫≠t gi√° th·ªã tr∆∞·ªùng s·∫Ω t·ª± ƒë·ªông t√≠nh l·∫°i gi√° tr·ªã hi·ªán t·∫°i c·ªßa t·∫•t c·∫£ t√†i s·∫£n c√πng lo·∫°i.
                </p>
                <div id="market-price-fields"></div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid var(--accent-blue);">
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">
                        üí° <strong>M·∫πo:</strong> Gi√° c·ªï phi·∫øu ƒë∆∞·ª£c qu·∫£n l√Ω ri√™ng trong b·∫£ng danh m·ª•c c·ªï phi·∫øu.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('market-price-modal')">Hu·ª∑</button>
                <button class="btn btn-success" onclick="saveMarketPrices()">üíæ C·∫≠p nh·∫≠t gi√°</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // ============== DATA STORE ==============
        let portfolioData = {
            stocks: [],
            otherAssets: [],
            monthlyReturns: {},
            transactions: [],
            performanceData: {}, // { year: { assetType: { month: percentage } } }
            monthlySnapshots: {}, // { "2025-01": { stock: {value, cost}, gold: {value, cost}, ... , total: {value, cost} } }
            marketPrices: {} // { gold: {price, unit, updatedAt}, paxg: {price, unit, updatedAt}, ... }
        };

        // Asset type configurations
        const assetTypeConfig = {
            stock: { name: 'C·ªï phi·∫øu', unit: '', badge: 'badge-blue', icon: 'üìà', hasMarketPrice: false },
            gold: { name: 'V√†ng nh·∫´n', unit: 'L∆∞·ª£ng', badge: 'badge-gold', icon: 'ü•á', hasMarketPrice: true, priceUnit: 'VNƒê/L∆∞·ª£ng' },
            gold_sjc: { name: 'V√†ng SJC', unit: 'L∆∞·ª£ng', badge: 'badge-gold', icon: 'üèÖ', hasMarketPrice: true, priceUnit: 'VNƒê/L∆∞·ª£ng' },
            paxg: { name: 'V√†ng PAXG', unit: 'PAXG', badge: 'badge-purple', icon: 'üíé', hasMarketPrice: true, priceUnit: 'USD/PAXG' },
            usdt: { name: 'USDT', unit: 'USDT', badge: 'badge-cyan', icon: 'üíµ', hasMarketPrice: true, priceUnit: 'VNƒê/USDT' },
            savings: { name: 'Ti·∫øt ki·ªám', unit: 'VNƒê', badge: 'badge-blue', icon: 'üè¶', hasMarketPrice: false },
            other: { name: 'Kh√°c', unit: '', badge: 'badge-blue', icon: 'üì¶', hasMarketPrice: false }
        };

        const months = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
                        'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];

        // ============== INITIALIZATION ==============
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderAll();
        });

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                portfolioData = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolioData));
        }

        // ============== RENDERING ==============
        function renderAll() {
            renderSummary();
            renderMarketPrices();
            renderCharts();
            renderStockTable();
            renderOtherAssetsTable();
            renderMonthlyReturns();
            renderTransactions();
        }

        function renderSummary() {
            let totalValue = 0;
            let totalCost = 0;

            // Calculate stocks
            portfolioData.stocks.forEach(stock => {
                totalValue += stock.quantity * stock.marketPrice;
                totalCost += stock.quantity * stock.costPrice;
            });

            // Calculate other assets
            portfolioData.otherAssets.forEach(asset => {
                if (asset.type === 'savings') {
                    totalValue += asset.amount;
                    totalCost += asset.amount;
                } else {
                    totalValue += asset.quantity * asset.currentPrice;
                    totalCost += asset.quantity * asset.costPrice;
                }
            });

            const totalProfit = totalValue - totalCost;
            const profitPercent = totalCost > 0 ? (totalProfit / totalCost * 100) : 0;

            document.getElementById('total-value').textContent = formatVND(totalValue);
            document.getElementById('total-cost').textContent = formatVND(totalCost);
            document.getElementById('total-profit').textContent = formatVND(totalProfit);
            
            const profitPercentEl = document.getElementById('profit-percent');
            const profitCard = document.getElementById('profit-card');
            
            if (totalProfit >= 0) {
                profitPercentEl.className = 'summary-change positive';
                profitPercentEl.innerHTML = `<span>‚Üë</span> ${profitPercent.toFixed(2)}%`;
                profitCard.className = 'summary-card profit animate-in delay-2';
            } else {
                profitPercentEl.className = 'summary-change negative';
                profitPercentEl.innerHTML = `<span>‚Üì</span> ${Math.abs(profitPercent).toFixed(2)}%`;
                profitCard.className = 'summary-card loss animate-in delay-2';
            }
        }

        // ============== MARKET PRICES ==============
        function renderMarketPrices() {
            const container = document.getElementById('market-prices-display');
            const updatedTimeEl = document.getElementById('prices-updated-time');
            
            if (!portfolioData.marketPrices) {
                portfolioData.marketPrices = {};
            }

            const priceTypes = ['gold', 'gold_sjc', 'paxg', 'usdt'];
            let html = '';
            let latestUpdate = null;

            priceTypes.forEach(type => {
                const config = assetTypeConfig[type];
                const priceData = portfolioData.marketPrices[type];
                
                if (priceData && priceData.price) {
                    html += `
                        <div class="market-price-item">
                            <span class="market-price-icon">${config.icon}</span>
                            <div class="market-price-info">
                                <div class="market-price-name">${config.name}</div>
                                <div class="market-price-value">
                                    ${formatNumber(priceData.price)}
                                    <span class="market-price-unit">${config.priceUnit}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    if (priceData.updatedAt && (!latestUpdate || new Date(priceData.updatedAt) > new Date(latestUpdate))) {
                        latestUpdate = priceData.updatedAt;
                    }
                } else {
                    html += `
                        <div class="market-price-item" style="opacity: 0.5;">
                            <span class="market-price-icon">${config.icon}</span>
                            <div class="market-price-info">
                                <div class="market-price-name">${config.name}</div>
                                <div class="market-price-value" style="color: var(--text-muted);">Ch∆∞a c·∫≠p nh·∫≠t</div>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
            
            if (latestUpdate) {
                const date = new Date(latestUpdate);
                updatedTimeEl.textContent = `C·∫≠p nh·∫≠t: ${date.toLocaleDateString('vi-VN')} ${date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}`;
            } else {
                updatedTimeEl.textContent = 'Ch∆∞a c·∫≠p nh·∫≠t gi√°';
            }
        }

        function openMarketPriceModal() {
            const modal = document.getElementById('market-price-modal');
            const container = document.getElementById('market-price-fields');
            
            if (!portfolioData.marketPrices) {
                portfolioData.marketPrices = {};
            }

            const priceTypes = ['gold', 'gold_sjc', 'paxg', 'usdt'];
            let html = '';

            priceTypes.forEach(type => {
                const config = assetTypeConfig[type];
                const priceData = portfolioData.marketPrices[type] || {};
                
                html += `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 0.75rem;">
                        <span style="font-size: 1.5rem;">${config.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${config.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${config.priceUnit}</div>
                        </div>
                        <div style="width: 180px;">
                            <input type="number" class="form-input" id="price-${type}" 
                                   value="${priceData.price || ''}" 
                                   placeholder="Nh·∫≠p gi√°...">
                        </div>
                    </div>
                `;
            });

            // Add USD/VND exchange rate for PAXG conversion
            html += `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(251, 191, 36, 0.1); border: 1px solid var(--accent-gold); border-radius: 12px; margin-top: 1rem;">
                    <span style="font-size: 1.5rem;">üí±</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">T·ª∑ gi√° USD/VND</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">D√πng ƒë·ªÉ quy ƒë·ªïi PAXG sang VND</div>
                    </div>
                    <div style="width: 180px;">
                        <input type="number" class="form-input" id="price-usdvnd" 
                               value="${portfolioData.marketPrices.usdvnd?.price || 25000}" 
                               placeholder="25000">
                    </div>
                </div>
            `;

            container.innerHTML = html;
            modal.classList.add('active');
        }

        function saveMarketPrices() {
            const priceTypes = ['gold', 'gold_sjc', 'paxg', 'usdt'];
            const now = new Date().toISOString();
            
            if (!portfolioData.marketPrices) {
                portfolioData.marketPrices = {};
            }

            priceTypes.forEach(type => {
                const price = parseFloat(document.getElementById(`price-${type}`).value);
                if (price && price > 0) {
                    portfolioData.marketPrices[type] = {
                        price: price,
                        updatedAt: now
                    };
                }
            });

            // Save USD/VND rate
            const usdvnd = parseFloat(document.getElementById('price-usdvnd').value);
            if (usdvnd && usdvnd > 0) {
                portfolioData.marketPrices.usdvnd = {
                    price: usdvnd,
                    updatedAt: now
                };
            }

            // Update all other assets with new prices
            updateAssetPricesFromMarket();

            saveData();
            renderAll();
            closeModal('market-price-modal');
            showToast('ƒê√£ c·∫≠p nh·∫≠t gi√° th·ªã tr∆∞·ªùng!', 'success');
        }

        function updateAssetPricesFromMarket() {
            const usdvnd = portfolioData.marketPrices.usdvnd?.price || 25000;

            portfolioData.otherAssets.forEach(asset => {
                if (portfolioData.marketPrices[asset.type]?.price) {
                    let newPrice = portfolioData.marketPrices[asset.type].price;
                    
                    // Convert PAXG from USD to VND
                    if (asset.type === 'paxg') {
                        newPrice = newPrice * usdvnd;
                    }
                    
                    asset.currentPrice = newPrice;
                }
            });
        }

        function renderCharts() {
            renderAllocationChart();
            renderStockChart();
        }

        function renderAllocationChart() {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            // Calculate allocation
            const allocation = {};
            let total = 0;

            // Stocks total
            let stocksTotal = 0;
            portfolioData.stocks.forEach(stock => {
                stocksTotal += stock.quantity * stock.marketPrice;
            });
            if (stocksTotal > 0) {
                allocation['C·ªï phi·∫øu'] = stocksTotal;
                total += stocksTotal;
            }

            // Other assets by type
            portfolioData.otherAssets.forEach(asset => {
                const config = assetTypeConfig[asset.type] || assetTypeConfig.other;
                const value = asset.type === 'savings' ? asset.amount : asset.quantity * asset.currentPrice;
                if (!allocation[config.name]) allocation[config.name] = 0;
                allocation[config.name] += value;
                total += value;
            });

            const labels = Object.keys(allocation);
            const data = Object.values(allocation);
            const colors = ['#10b981', '#fbbf24', '#f59e0b', '#8b5cf6', '#06b6d4', '#3b82f6', '#f43f5e'];

            // Destroy existing chart
            if (window.allocationChart && typeof window.allocationChart.destroy === 'function') {
                window.allocationChart.destroy();
            }

            if (labels.length === 0) {
                document.getElementById('allocation-legend').innerHTML = '<div class="empty-state-subtext">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
                return;
            }

            window.allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1a2235',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percent = (context.raw / total * 100).toFixed(2);
                                    return `${context.label}: ${formatVND(context.raw)} (${percent}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });

            // Render legend
            let legendHtml = '';
            labels.forEach((label, i) => {
                const percent = (data[i] / total * 100).toFixed(2);
                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colors[i]}"></div>
                        <span>${label}: ${percent}%</span>
                    </div>
                `;
            });
            document.getElementById('allocation-legend').innerHTML = legendHtml;
        }

        function renderStockChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            if (portfolioData.stocks.length === 0) {
                if (window.stockChart && typeof window.stockChart.destroy === 'function') {
                    window.stockChart.destroy();
                }
                document.getElementById('stock-legend').innerHTML = '<div class="empty-state-subtext">Ch∆∞a c√≥ c·ªï phi·∫øu</div>';
                return;
            }

            let total = 0;
            portfolioData.stocks.forEach(stock => {
                total += stock.quantity * stock.marketPrice;
            });

            const labels = portfolioData.stocks.map(s => s.code);
            const data = portfolioData.stocks.map(s => s.quantity * s.marketPrice);
            const colors = ['#3b82f6', '#10b981', '#fbbf24', '#f43f5e', '#8b5cf6', '#06b6d4', '#f59e0b', '#ec4899'];

            if (window.stockChart && typeof window.stockChart.destroy === 'function') {
                window.stockChart.destroy();
            }

            window.stockChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1a2235',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percent = (context.raw / total * 100).toFixed(2);
                                    return `${context.label}: ${formatVND(context.raw)} (${percent}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });

            // Render legend
            let legendHtml = '';
            labels.forEach((label, i) => {
                const percent = (data[i] / total * 100).toFixed(2);
                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colors[i % colors.length]}"></div>
                        <span>${label}: ${percent}%</span>
                    </div>
                `;
            });
            document.getElementById('stock-legend').innerHTML = legendHtml;
        }

        function renderStockTable() {
            const tbody = document.getElementById('stock-table-body');
            
            if (portfolioData.stocks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìà</div>
                                <div class="empty-state-text">Ch∆∞a c√≥ c·ªï phi·∫øu n√†o</div>
                                <div class="empty-state-subtext">Nh·∫•n "Th√™m c·ªï phi·∫øu" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate total for weight
            let totalValue = 0;
            portfolioData.stocks.forEach(s => totalValue += s.quantity * s.marketPrice);

            let html = '';
            portfolioData.stocks.forEach((stock, index) => {
                const costValue = stock.quantity * stock.costPrice;
                const marketValue = stock.quantity * stock.marketPrice;
                const profit = marketValue - costValue;
                const profitPercent = costValue > 0 ? (profit / costValue * 100) : 0;
                const weight = totalValue > 0 ? (marketValue / totalValue * 100) : 0;

                html += `
                    <tr>
                        <td>
                            <div class="stock-name">
                                <div class="stock-code">${stock.code}</div>
                                <div class="stock-company">${stock.company || ''}</div>
                            </div>
                        </td>
                        <td>${weight.toFixed(2)}%</td>
                        <td>${formatNumber(stock.quantity)}</td>
                        <td>${formatNumber(stock.costPrice)}</td>
                        <td>${formatNumber(stock.marketPrice)}</td>
                        <td>${formatVND(costValue)}</td>
                        <td>${formatVND(marketValue)}</td>
                        <td class="${profit >= 0 ? 'positive' : 'negative'}">${formatVND(profit)}</td>
                        <td class="${profitPercent >= 0 ? 'positive' : 'negative'}">${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%</td>
                        <td>
                            <button class="action-btn" onclick="editStock(${index})" title="S·ª≠a">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteStock(${index})" title="Xo√°">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function renderOtherAssetsTable() {
            const tbody = document.getElementById('other-table-body');
            
            if (portfolioData.otherAssets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11">
                            <div class="empty-state">
                                <div class="empty-state-icon">üíé</div>
                                <div class="empty-state-text">Ch∆∞a c√≥ t√†i s·∫£n n√†o</div>
                                <div class="empty-state-subtext">Nh·∫•n "Th√™m t√†i s·∫£n" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate total for weight
            let totalValue = 0;
            portfolioData.otherAssets.forEach(a => {
                totalValue += a.type === 'savings' ? a.amount : a.quantity * a.currentPrice;
            });

            // Group assets by type
            const groupedAssets = {};
            portfolioData.otherAssets.forEach((asset, index) => {
                if (!groupedAssets[asset.type]) {
                    groupedAssets[asset.type] = {
                        assets: [],
                        totalQuantity: 0,
                        totalCost: 0,
                        totalValue: 0,
                        unit: asset.unit
                    };
                }
                groupedAssets[asset.type].assets.push({ ...asset, originalIndex: index });
                
                if (asset.type === 'savings') {
                    groupedAssets[asset.type].totalQuantity += asset.amount;
                    groupedAssets[asset.type].totalCost += asset.amount;
                    groupedAssets[asset.type].totalValue += asset.amount;
                } else {
                    groupedAssets[asset.type].totalQuantity += asset.quantity;
                    groupedAssets[asset.type].totalCost += asset.quantity * asset.costPrice;
                    groupedAssets[asset.type].totalValue += asset.quantity * asset.currentPrice;
                }
            });

            let html = '';
            
            // Render by groups
            Object.keys(groupedAssets).forEach(type => {
                const group = groupedAssets[type];
                const config = assetTypeConfig[type] || assetTypeConfig.other;
                
                // Render group header/summary if more than 1 asset or always show summary
                if (group.assets.length >= 1) {
                    const groupProfit = group.totalValue - group.totalCost;
                    const groupProfitPercent = group.totalCost > 0 ? (groupProfit / group.totalCost * 100) : 0;
                    const groupWeight = totalValue > 0 ? (group.totalValue / totalValue * 100) : 0;
                    
                    html += `
                        <tr style="background: var(--bg-secondary);">
                            <td colspan="2">
                                <strong><span class="badge ${config.badge}">${config.icon} ${config.name}</span></strong>
                                <span style="margin-left: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">(${group.assets.length} m·ª•c)</span>
                            </td>
                            <td style="font-weight: 600;">${type === 'savings' ? formatVND(group.totalQuantity) : formatNumber(group.totalQuantity)}</td>
                            <td>${group.unit}</td>
                            <td colspan="2"></td>
                            <td style="font-weight: 600;">${formatVND(group.totalCost)}</td>
                            <td style="font-weight: 600;">${formatVND(group.totalValue)}</td>
                            <td class="${groupProfit >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${formatVND(groupProfit)}</td>
                            <td class="${groupProfitPercent >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">${groupProfitPercent >= 0 ? '+' : ''}${groupProfitPercent.toFixed(2)}%</td>
                            <td></td>
                        </tr>
                    `;
                }

                // Render individual assets
                group.assets.forEach(asset => {
                    const index = asset.originalIndex;
                    
                    if (asset.type === 'savings') {
                        const weight = totalValue > 0 ? (asset.amount / totalValue * 100) : 0;
                        html += `
                            <tr>
                                <td style="padding-left: 2rem;">
                                    <span style="color: var(--text-secondary);">‚îî</span> ${asset.name}
                                </td>
                                <td>${weight.toFixed(2)}%</td>
                                <td colspan="2">${formatVND(asset.amount)}</td>
                                <td colspan="4">L√£i su·∫•t: ${asset.rate}%/nƒÉm</td>
                                <td class="neutral-text">‚Äî</td>
                                <td class="neutral-text">‚Äî</td>
                                <td>
                                    <button class="action-btn" onclick="editOtherAsset(${index})" title="S·ª≠a">‚úèÔ∏è</button>
                                    <button class="action-btn delete" onclick="deleteOtherAsset(${index})" title="Xo√°">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    } else {
                        const costValue = asset.quantity * asset.costPrice;
                        const currentValue = asset.quantity * asset.currentPrice;
                        const profit = currentValue - costValue;
                        const profitPercent = costValue > 0 ? (profit / costValue * 100) : 0;
                        const weight = totalValue > 0 ? (currentValue / totalValue * 100) : 0;

                        html += `
                            <tr>
                                <td style="padding-left: 2rem;">
                                    <span style="color: var(--text-secondary);">‚îî</span> ${asset.name}
                                </td>
                                <td>${weight.toFixed(2)}%</td>
                                <td>${formatNumber(asset.quantity)}</td>
                                <td>${asset.unit}</td>
                                <td>${formatNumber(asset.costPrice)}</td>
                                <td>${formatNumber(asset.currentPrice)}</td>
                                <td>${formatVND(costValue)}</td>
                                <td>${formatVND(currentValue)}</td>
                                <td class="${profit >= 0 ? 'positive' : 'negative'}">${formatVND(profit)}</td>
                                <td class="${profitPercent >= 0 ? 'positive' : 'negative'}">${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%</td>
                                <td>
                                    <button class="action-btn" onclick="editOtherAsset(${index})" title="S·ª≠a">‚úèÔ∏è</button>
                                    <button class="action-btn delete" onclick="deleteOtherAsset(${index})" title="Xo√°">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    }
                });
            });

            // Grand total row
            let grandTotalCost = 0;
            let grandTotalValue = 0;
            Object.values(groupedAssets).forEach(group => {
                grandTotalCost += group.totalCost;
                grandTotalValue += group.totalValue;
            });
            const grandProfit = grandTotalValue - grandTotalCost;
            const grandProfitPercent = grandTotalCost > 0 ? (grandProfit / grandTotalCost * 100) : 0;

            html += `
                <tr style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border-top: 2px solid var(--accent-gold);">
                    <td colspan="6"><strong>üìä T·ªîNG C·ªòNG T√ÄI S·∫¢N KH√ÅC</strong></td>
                    <td style="font-weight: 700;">${formatVND(grandTotalCost)}</td>
                    <td style="font-weight: 700;">${formatVND(grandTotalValue)}</td>
                    <td class="${grandProfit >= 0 ? 'positive' : 'negative'}" style="font-weight: 700;">${formatVND(grandProfit)}</td>
                    <td class="${grandProfitPercent >= 0 ? 'positive' : 'negative'}" style="font-weight: 700;">${grandProfitPercent >= 0 ? '+' : ''}${grandProfitPercent.toFixed(2)}%</td>
                    <td></td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        function renderMonthlyReturns() {
            const year = document.getElementById('year-select').value;
            const grid = document.getElementById('monthly-grid');
            
            if (!portfolioData.monthlyReturns[year]) {
                portfolioData.monthlyReturns[year] = {};
            }

            let html = '';
            months.forEach((month, i) => {
                const value = portfolioData.monthlyReturns[year][i + 1] || 0;
                const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral-text';
                html += `
                    <div class="month-card">
                        <div class="month-name">${month}</div>
                        <div class="month-value ${colorClass}">${value > 0 ? '+' : ''}${value.toFixed(2)}%</div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function renderTransactions() {
            const tbody = document.getElementById('history-table-body');
            
            if (!portfolioData.transactions || portfolioData.transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìú</div>
                                <div class="empty-state-text">Ch∆∞a c√≥ l·ªãch s·ª≠ giao d·ªãch</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            portfolioData.transactions.slice().reverse().forEach(tx => {
                html += `
                    <tr>
                        <td>${tx.date}</td>
                        <td><span class="badge badge-blue">${tx.type}</span></td>
                        <td>${tx.asset}</td>
                        <td>${tx.action}</td>
                        <td>${formatNumber(tx.quantity)}</td>
                        <td>${formatNumber(tx.price)}</td>
                        <td>${formatVND(tx.total)}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // ============== MODALS ==============
        function openAddModal(type = null) {
            const modal = document.getElementById('add-modal');
            modal.classList.add('active');
            
            // Reset form
            document.getElementById('asset-type').value = type === 'stock' ? 'stock' : (type === 'other' ? 'gold' : 'stock');
            toggleAssetFields();
            
            // Clear inputs
            document.querySelectorAll('#add-modal input').forEach(input => {
                if (input.type !== 'date') input.value = '';
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleAssetFields() {
            const type = document.getElementById('asset-type').value;
            document.getElementById('stock-fields').style.display = type === 'stock' ? 'block' : 'none';
            document.getElementById('other-fields').style.display = ['gold', 'gold_sjc', 'paxg', 'usdt', 'other'].includes(type) ? 'block' : 'none';
            document.getElementById('savings-fields').style.display = type === 'savings' ? 'block' : 'none';

            // Set default unit
            if (type !== 'stock' && type !== 'savings') {
                const config = assetTypeConfig[type];
                document.getElementById('asset-unit').value = config.unit;
                document.getElementById('asset-name').value = config.name;
            }
        }

        function saveAsset() {
            const type = document.getElementById('asset-type').value;
            const dateInput = document.getElementById('transaction-date').value;
            const transactionDate = dateInput ? new Date(dateInput).toLocaleDateString('vi-VN') : new Date().toLocaleDateString('vi-VN');

            if (type === 'stock') {
                const code = document.getElementById('stock-code').value.trim().toUpperCase();
                const company = document.getElementById('stock-company').value.trim();
                const quantity = parseInt(document.getElementById('stock-quantity').value) || 0;
                const costPrice = parseFloat(document.getElementById('stock-cost').value) || 0;
                const marketPrice = parseFloat(document.getElementById('stock-market').value) || 0;

                if (!code || quantity <= 0) {
                    showToast('Vui l√≤ng nh·∫≠p m√£ CK v√† kh·ªëi l∆∞·ª£ng', 'error');
                    return;
                }

                // Check if stock exists
                const existingIndex = portfolioData.stocks.findIndex(s => s.code === code);
                if (existingIndex >= 0) {
                    // Update existing
                    const existing = portfolioData.stocks[existingIndex];
                    const totalQty = existing.quantity + quantity;
                    const avgCost = (existing.quantity * existing.costPrice + quantity * costPrice) / totalQty;
                    existing.quantity = totalQty;
                    existing.costPrice = avgCost;
                    existing.marketPrice = marketPrice || existing.marketPrice;
                    existing.company = company || existing.company;
                } else {
                    portfolioData.stocks.push({ code, company, quantity, costPrice, marketPrice });
                }

                // Add transaction
                portfolioData.transactions.push({
                    date: transactionDate,
                    type: 'C·ªï phi·∫øu',
                    asset: code,
                    action: 'Mua',
                    quantity,
                    price: costPrice,
                    total: quantity * costPrice
                });

            } else if (type === 'savings') {
                const name = document.getElementById('savings-name').value.trim() || 'Ti·∫øt ki·ªám';
                const amount = parseFloat(document.getElementById('savings-amount').value) || 0;
                const rate = parseFloat(document.getElementById('savings-rate').value) || 0;

                if (amount <= 0) {
                    showToast('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn g·ª≠i', 'error');
                    return;
                }

                portfolioData.otherAssets.push({ type, name, amount, rate, unit: 'VNƒê' });

                portfolioData.transactions.push({
                    date: transactionDate,
                    type: 'Ti·∫øt ki·ªám',
                    asset: name,
                    action: 'G·ª≠i',
                    quantity: 1,
                    price: amount,
                    total: amount
                });

            } else {
                const name = document.getElementById('asset-name').value.trim();
                const quantity = parseFloat(document.getElementById('asset-quantity').value) || 0;
                const unit = document.getElementById('asset-unit').value.trim();
                const costPrice = parseFloat(document.getElementById('asset-cost').value) || 0;
                const currentPrice = parseFloat(document.getElementById('asset-price').value) || 0;

                if (!name || quantity <= 0) {
                    showToast('Vui l√≤ng nh·∫≠p t√™n v√† s·ªë l∆∞·ª£ng', 'error');
                    return;
                }

                portfolioData.otherAssets.push({ type, name, quantity, unit, costPrice, currentPrice });

                portfolioData.transactions.push({
                    date: transactionDate,
                    type: assetTypeConfig[type]?.name || 'Kh√°c',
                    asset: name,
                    action: 'Mua',
                    quantity,
                    price: costPrice,
                    total: quantity * costPrice
                });
            }

            saveData();
            renderAll();
            closeModal('add-modal');
            showToast('ƒê√£ th√™m t√†i s·∫£n th√†nh c√¥ng!', 'success');
        }

        function editStock(index) {
            const stock = portfolioData.stocks[index];
            const body = document.getElementById('edit-modal-body');
            
            body.innerHTML = `
                <div class="form-group">
                    <label class="form-label">M√£ ch·ª©ng kho√°n</label>
                    <input type="text" class="form-input" id="edit-stock-code" value="${stock.code}" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">T√™n c√¥ng ty</label>
                    <input type="text" class="form-input" id="edit-stock-company" value="${stock.company || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Kh·ªëi l∆∞·ª£ng</label>
                        <input type="number" class="form-input" id="edit-stock-quantity" value="${stock.quantity}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gi√° v·ªën</label>
                        <input type="number" class="form-input" id="edit-stock-cost" value="${stock.costPrice}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Gi√° th·ªã tr∆∞·ªùng</label>
                    <input type="number" class="form-input" id="edit-stock-market" value="${stock.marketPrice}">
                </div>
            `;

            document.getElementById('edit-save-btn').onclick = () => {
                portfolioData.stocks[index] = {
                    code: stock.code,
                    company: document.getElementById('edit-stock-company').value.trim(),
                    quantity: parseInt(document.getElementById('edit-stock-quantity').value) || 0,
                    costPrice: parseFloat(document.getElementById('edit-stock-cost').value) || 0,
                    marketPrice: parseFloat(document.getElementById('edit-stock-market').value) || 0
                };
                saveData();
                renderAll();
                closeModal('edit-modal');
                showToast('ƒê√£ c·∫≠p nh·∫≠t c·ªï phi·∫øu!', 'success');
            };

            document.getElementById('edit-modal').classList.add('active');
        }

        function deleteStock(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° c·ªï phi·∫øu n√†y?')) {
                portfolioData.stocks.splice(index, 1);
                saveData();
                renderAll();
                showToast('ƒê√£ xo√° c·ªï phi·∫øu!', 'success');
            }
        }

        function editOtherAsset(index) {
            const asset = portfolioData.otherAssets[index];
            const body = document.getElementById('edit-modal-body');
            
            if (asset.type === 'savings') {
                body.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">T√™n kho·∫£n ti·∫øt ki·ªám</label>
                        <input type="text" class="form-input" id="edit-asset-name" value="${asset.name}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">S·ªë ti·ªÅn g·ª≠i</label>
                            <input type="number" class="form-input" id="edit-asset-amount" value="${asset.amount}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">L√£i su·∫•t (%/nƒÉm)</label>
                            <input type="number" step="0.01" class="form-input" id="edit-asset-rate" value="${asset.rate}">
                        </div>
                    </div>
                `;

                document.getElementById('edit-save-btn').onclick = () => {
                    portfolioData.otherAssets[index] = {
                        type: 'savings',
                        name: document.getElementById('edit-asset-name').value.trim(),
                        amount: parseFloat(document.getElementById('edit-asset-amount').value) || 0,
                        rate: parseFloat(document.getElementById('edit-asset-rate').value) || 0,
                        unit: 'VNƒê'
                    };
                    saveData();
                    renderAll();
                    closeModal('edit-modal');
                    showToast('ƒê√£ c·∫≠p nh·∫≠t t√†i s·∫£n!', 'success');
                };
            } else {
                body.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">T√™n t√†i s·∫£n</label>
                        <input type="text" class="form-input" id="edit-asset-name" value="${asset.name}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">S·ªë l∆∞·ª£ng</label>
                            <input type="number" step="0.01" class="form-input" id="edit-asset-quantity" value="${asset.quantity}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ƒê∆°n v·ªã</label>
                            <input type="text" class="form-input" id="edit-asset-unit" value="${asset.unit}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Gi√° v·ªën / ƒë∆°n v·ªã</label>
                            <input type="number" class="form-input" id="edit-asset-cost" value="${asset.costPrice}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gi√° hi·ªán t·∫°i / ƒë∆°n v·ªã</label>
                            <input type="number" class="form-input" id="edit-asset-price" value="${asset.currentPrice}">
                        </div>
                    </div>
                `;

                document.getElementById('edit-save-btn').onclick = () => {
                    portfolioData.otherAssets[index] = {
                        type: asset.type,
                        name: document.getElementById('edit-asset-name').value.trim(),
                        quantity: parseFloat(document.getElementById('edit-asset-quantity').value) || 0,
                        unit: document.getElementById('edit-asset-unit').value.trim(),
                        costPrice: parseFloat(document.getElementById('edit-asset-cost').value) || 0,
                        currentPrice: parseFloat(document.getElementById('edit-asset-price').value) || 0
                    };
                    saveData();
                    renderAll();
                    closeModal('edit-modal');
                    showToast('ƒê√£ c·∫≠p nh·∫≠t t√†i s·∫£n!', 'success');
                };
            }

            document.getElementById('edit-modal').classList.add('active');
        }

        function deleteOtherAsset(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° t√†i s·∫£n n√†y?')) {
                portfolioData.otherAssets.splice(index, 1);
                saveData();
                renderAll();
                showToast('ƒê√£ xo√° t√†i s·∫£n!', 'success');
            }
        }

        function openMonthlyModal() {
            const year = document.getElementById('year-select').value;
            const body = document.getElementById('monthly-edit-body');
            
            if (!portfolioData.monthlyReturns[year]) {
                portfolioData.monthlyReturns[year] = {};
            }

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
            months.forEach((month, i) => {
                const value = portfolioData.monthlyReturns[year][i + 1] || 0;
                html += `
                    <div class="form-group">
                        <label class="form-label">${month}</label>
                        <input type="number" step="0.01" class="form-input" id="monthly-${i+1}" value="${value}" placeholder="0">
                    </div>
                `;
            });
            html += '</div>';
            body.innerHTML = html;

            document.getElementById('monthly-modal').classList.add('active');
        }

        function saveMonthlyReturns() {
            const year = document.getElementById('year-select').value;
            portfolioData.monthlyReturns[year] = {};
            
            months.forEach((_, i) => {
                const value = parseFloat(document.getElementById(`monthly-${i+1}`).value) || 0;
                portfolioData.monthlyReturns[year][i + 1] = value;
            });

            saveData();
            renderMonthlyReturns();
            closeModal('monthly-modal');
            showToast('ƒê√£ c·∫≠p nh·∫≠t l·ª£i nhu·∫≠n th√°ng!', 'success');
        }

        function updateMonthlyView() {
            renderMonthlyReturns();
        }

        // ============== TABS ==============
        function switchTab(btn, tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('monthly-content').style.display = tab === 'monthly' ? 'block' : 'none';
            document.getElementById('history-content').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('performance-content').style.display = tab === 'performance' ? 'block' : 'none';
            
            if (tab === 'performance') {
                renderPerformanceView();
            }
        }

        // ============== PERFORMANCE TRACKING ==============
        function getCurrentAssetValues() {
            const values = {
                stock: { value: 0, cost: 0 },
                gold: { value: 0, cost: 0 },
                gold_sjc: { value: 0, cost: 0 },
                paxg: { value: 0, cost: 0 },
                usdt: { value: 0, cost: 0 },
                savings: { value: 0, cost: 0 },
                total: { value: 0, cost: 0 }
            };

            // Calculate stocks
            portfolioData.stocks.forEach(stock => {
                values.stock.value += stock.quantity * stock.marketPrice;
                values.stock.cost += stock.quantity * stock.costPrice;
            });

            // Calculate other assets
            portfolioData.otherAssets.forEach(asset => {
                if (asset.type === 'savings') {
                    values.savings.value += asset.amount;
                    values.savings.cost += asset.amount;
                } else if (values[asset.type]) {
                    values[asset.type].value += asset.quantity * asset.currentPrice;
                    values[asset.type].cost += asset.quantity * asset.costPrice;
                }
            });

            // Calculate total
            Object.keys(values).forEach(key => {
                if (key !== 'total') {
                    values.total.value += values[key].value;
                    values.total.cost += values[key].cost;
                }
            });

            return values;
        }

        function calculateMonthlyReturns(year) {
            const assetTypes = ['stock', 'gold', 'gold_sjc', 'paxg', 'usdt', 'savings'];
            const returns = {};

            assetTypes.forEach(type => {
                returns[type] = {};
                for (let m = 1; m <= 12; m++) {
                    const currentKey = `${year}-${String(m).padStart(2, '0')}`;
                    const prevMonth = m === 1 ? 12 : m - 1;
                    const prevYear = m === 1 ? parseInt(year) - 1 : year;
                    const prevKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;

                    const currentSnapshot = portfolioData.monthlySnapshots?.[currentKey];
                    const prevSnapshot = portfolioData.monthlySnapshots?.[prevKey];

                    if (currentSnapshot && currentSnapshot[type] && prevSnapshot && prevSnapshot[type]) {
                        const currentValue = currentSnapshot[type].value;
                        const prevValue = prevSnapshot[type].value;
                        
                        if (prevValue > 0) {
                            returns[type][m] = ((currentValue - prevValue) / prevValue) * 100;
                        }
                    }
                }
            });

            // Calculate total returns
            returns.total = {};
            for (let m = 1; m <= 12; m++) {
                const currentKey = `${year}-${String(m).padStart(2, '0')}`;
                const prevMonth = m === 1 ? 12 : m - 1;
                const prevYear = m === 1 ? parseInt(year) - 1 : year;
                const prevKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;

                const currentSnapshot = portfolioData.monthlySnapshots?.[currentKey];
                const prevSnapshot = portfolioData.monthlySnapshots?.[prevKey];

                if (currentSnapshot?.total && prevSnapshot?.total) {
                    const currentValue = currentSnapshot.total.value;
                    const prevValue = prevSnapshot.total.value;
                    
                    if (prevValue > 0) {
                        returns.total[m] = ((currentValue - prevValue) / prevValue) * 100;
                    }
                }
            }

            return returns;
        }

        function renderPerformanceView() {
            const year = document.getElementById('perf-year-select').value;
            const tbody = document.getElementById('performance-table-body');
            
            const returns = calculateMonthlyReturns(year);
            const assetTypes = ['stock', 'gold', 'gold_sjc', 'paxg', 'usdt', 'savings'];
            const colors = {
                stock: '#3b82f6',
                gold: '#fbbf24',
                gold_sjc: '#f59e0b',
                paxg: '#8b5cf6',
                usdt: '#06b6d4',
                savings: '#10b981'
            };

            let html = '';
            const chartData = {};

            assetTypes.forEach(type => {
                const config = assetTypeConfig[type];
                const typeReturns = returns[type] || {};
                
                let yearTotal = 0;
                let hasData = false;
                
                html += `<tr>
                    <td><span class="badge ${config.badge}">${config.icon} ${config.name}</span></td>`;
                
                for (let m = 1; m <= 12; m++) {
                    const value = typeReturns[m];
                    if (value !== undefined && value !== null) {
                        hasData = true;
                        yearTotal += value;
                        const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral-text';
                        html += `<td class="${colorClass}">${value > 0 ? '+' : ''}${value.toFixed(2)}%</td>`;
                    } else {
                        html += `<td class="neutral-text">‚Äî</td>`;
                    }
                }
                
                // Year total (compounded would be more accurate, but sum is simpler)
                if (hasData) {
                    const colorClass = yearTotal > 0 ? 'positive' : yearTotal < 0 ? 'negative' : 'neutral-text';
                    html += `<td class="${colorClass}" style="font-weight: 600;">${yearTotal > 0 ? '+' : ''}${yearTotal.toFixed(2)}%</td>`;
                } else {
                    html += `<td class="neutral-text">‚Äî</td>`;
                }
                
                html += `</tr>`;
                
                // Prepare chart data
                chartData[type] = {
                    label: config.name,
                    color: colors[type],
                    data: []
                };
                for (let m = 1; m <= 12; m++) {
                    chartData[type].data.push(typeReturns[m] !== undefined ? typeReturns[m] : null);
                }
            });

            // Add total row
            const totalReturns = returns.total || {};
            html += `<tr style="background: var(--bg-secondary);">
                <td><strong>üìä T·ªïng danh m·ª•c</strong></td>`;
            
            let grandTotal = 0;
            let hasGrandData = false;
            for (let m = 1; m <= 12; m++) {
                const value = totalReturns[m];
                if (value !== undefined && value !== null) {
                    hasGrandData = true;
                    grandTotal += value;
                    const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral-text';
                    html += `<td class="${colorClass}" style="font-weight: 600;">${value > 0 ? '+' : ''}${value.toFixed(2)}%</td>`;
                } else {
                    html += `<td class="neutral-text">‚Äî</td>`;
                }
            }
            
            if (hasGrandData) {
                const grandColorClass = grandTotal > 0 ? 'positive' : grandTotal < 0 ? 'negative' : 'neutral-text';
                html += `<td class="${grandColorClass}" style="font-weight: 700;">${grandTotal > 0 ? '+' : ''}${grandTotal.toFixed(2)}%</td>`;
            } else {
                html += `<td class="neutral-text">‚Äî</td>`;
            }
            html += `</tr>`;

            tbody.innerHTML = html;

            // Render chart
            renderPerformanceChart(chartData);
            
            // Render snapshot history
            renderSnapshotHistory(year);
        }

        function renderSnapshotHistory(year) {
            const tbody = document.getElementById('snapshot-history-body');
            if (!tbody) return;

            const assetTypes = ['stock', 'gold', 'gold_sjc', 'paxg', 'usdt', 'savings'];
            let html = '';
            
            // Get all snapshots for the year
            const yearSnapshots = [];
            for (let m = 1; m <= 12; m++) {
                const key = `${year}-${String(m).padStart(2, '0')}`;
                if (portfolioData.monthlySnapshots?.[key]) {
                    yearSnapshots.push({ month: m, key, data: portfolioData.monthlySnapshots[key] });
                }
            }

            if (yearSnapshots.length === 0) {
                html = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    Ch∆∞a c√≥ d·ªØ li·ªáu ch·ªët gi√° tr·ªã. Nh·∫•n "üì∏ Ch·ªët gi√° tr·ªã th√°ng" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </td></tr>`;
            } else {
                yearSnapshots.forEach(({ month, key, data }) => {
                    html += `<tr>
                        <td><strong>Th√°ng ${month}/${year}</strong></td>`;
                    
                    assetTypes.forEach(type => {
                        const value = data[type]?.value || 0;
                        html += `<td>${value > 0 ? formatVND(value) : '‚Äî'}</td>`;
                    });
                    
                    html += `<td style="font-weight: 600;">${formatVND(data.total?.value || 0)}</td>`;
                    html += `<td><button class="action-btn delete" onclick="deleteSnapshot('${key}')" title="Xo√°">üóëÔ∏è</button></td>`;
                    html += `</tr>`;
                });
            }

            tbody.innerHTML = html;
        }

        function renderPerformanceChart(chartData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (window.performanceChart && typeof window.performanceChart.destroy === 'function') {
                window.performanceChart.destroy();
            }

            const datasets = [];
            Object.keys(chartData).forEach(type => {
                const data = chartData[type];
                // Only show datasets that have some data
                if (data.data.some(v => v !== null)) {
                    datasets.push({
                        label: data.label,
                        data: data.data,
                        borderColor: data.color,
                        backgroundColor: data.color + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }
            });

            window.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#94a3b8',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === null) return null;
                                    return `${context.dataset.label}: ${context.raw > 0 ? '+' : ''}${context.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#374151' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function openSnapshotModal() {
            const modal = document.getElementById('snapshot-modal');
            
            // Set default month to current month
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('snapshot-month').value = currentMonth;
            
            // Load current values
            loadCurrentValues();
            
            modal.classList.add('active');
        }

        function loadCurrentValues() {
            const values = getCurrentAssetValues();
            const assetTypes = ['stock', 'gold', 'gold_sjc', 'paxg', 'usdt', 'savings'];
            
            let html = '';
            assetTypes.forEach(type => {
                const config = assetTypeConfig[type];
                const typeValue = values[type];
                
                html += `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 0.75rem;">
                        <div style="flex: 1;">
                            <span class="badge ${config.badge}">${config.icon} ${config.name}</span>
                        </div>
                        <div style="flex: 2;">
                            <label class="form-label" style="font-size: 0.75rem;">Gi√° tr·ªã (VNƒê)</label>
                            <input type="number" class="form-input" id="snap-${type}-value" value="${typeValue.value}" placeholder="0">
                        </div>
                        <div style="flex: 2;">
                            <label class="form-label" style="font-size: 0.75rem;">Gi√° v·ªën (VNƒê)</label>
                            <input type="number" class="form-input" id="snap-${type}-cost" value="${typeValue.cost}" placeholder="0">
                        </div>
                    </div>
                `;
            });

            // Total
            html += `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--accent-gold); background: rgba(251, 191, 36, 0.1); border: 1px solid var(--accent-gold); border-radius: 12px; margin-top: 1rem;">
                    <div style="flex: 1;">
                        <strong>üìä T·ªïng c·ªông</strong>
                    </div>
                    <div style="flex: 2;">
                        <span class="form-label" style="font-size: 0.75rem;">Gi√° tr·ªã</span>
                        <div style="font-family: 'JetBrains Mono'; font-size: 1.1rem; font-weight: 600;" id="snap-total-value">${formatVND(values.total.value)}</div>
                    </div>
                    <div style="flex: 2;">
                        <span class="form-label" style="font-size: 0.75rem;">Gi√° v·ªën</span>
                        <div style="font-family: 'JetBrains Mono'; font-size: 1.1rem;" id="snap-total-cost">${formatVND(values.total.cost)}</div>
                    </div>
                </div>
            `;

            document.getElementById('snapshot-fields').innerHTML = html;

            // Add listeners to update total
            assetTypes.forEach(type => {
                document.getElementById(`snap-${type}-value`).addEventListener('input', updateSnapshotTotal);
                document.getElementById(`snap-${type}-cost`).addEventListener('input', updateSnapshotTotal);
            });
        }

        function updateSnapshotTotal() {
            const assetTypes = ['stock', 'gold', 'gold_sjc', 'paxg', 'usdt', 'savings'];
            let totalValue = 0;
            let totalCost = 0;

            assetTypes.forEach(type => {
                totalValue += parseFloat(document.getElementById(`snap-${type}-value`).value) || 0;
                totalCost += parseFloat(document.getElementById(`snap-${type}-cost`).value) || 0;
            });

            document.getElementById('snap-total-value').textContent = formatVND(totalValue);
            document.getElementById('snap-total-cost').textContent = formatVND(totalCost);
        }

        function saveSnapshot() {
            const monthInput = document.getElementById('snapshot-month').value;
            if (!monthInput) {
                showToast('Vui l√≤ng ch·ªçn th√°ng', 'error');
                return;
            }

            const assetTypes = ['stock', 'gold', 'gold_sjc', 'paxg', 'usdt', 'savings'];
            
            if (!portfolioData.monthlySnapshots) {
                portfolioData.monthlySnapshots = {};
            }

            const snapshot = {
                total: { value: 0, cost: 0 }
            };

            assetTypes.forEach(type => {
                const value = parseFloat(document.getElementById(`snap-${type}-value`).value) || 0;
                const cost = parseFloat(document.getElementById(`snap-${type}-cost`).value) || 0;
                snapshot[type] = { value, cost };
                snapshot.total.value += value;
                snapshot.total.cost += cost;
            });

            portfolioData.monthlySnapshots[monthInput] = snapshot;

            saveData();
            renderPerformanceView();
            closeModal('snapshot-modal');
            showToast(`ƒê√£ ch·ªët gi√° tr·ªã th√°ng ${monthInput}!`, 'success');
        }

        function deleteSnapshot(key) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d·ªØ li·ªáu ch·ªët gi√° tr·ªã ${key}?`)) {
                delete portfolioData.monthlySnapshots[key];
                saveData();
                renderPerformanceView();
                showToast('ƒê√£ xo√° d·ªØ li·ªáu!', 'success');
            }
        }

        // ============== IMPORT/EXPORT ==============
        function exportCSV() {
            let csv = 'Lo·∫°i,M√£/T√™n,C√¥ng ty,S·ªë l∆∞·ª£ng,ƒê∆°n v·ªã,Gi√° v·ªën,Gi√° hi·ªán t·∫°i,L√£i su·∫•t\n';

            portfolioData.stocks.forEach(stock => {
                csv += `stock,${stock.code},${stock.company || ''},${stock.quantity},,${stock.costPrice},${stock.marketPrice},\n`;
            });

            portfolioData.otherAssets.forEach(asset => {
                if (asset.type === 'savings') {
                    csv += `${asset.type},${asset.name},,${asset.amount},VNƒê,,,${asset.rate}\n`;
                } else {
                    csv += `${asset.type},${asset.name},,${asset.quantity},${asset.unit},${asset.costPrice},${asset.currentPrice},\n`;
                }
            });

            // Add market prices
            csv += '\nGi√° th·ªã tr∆∞·ªùng\n';
            csv += 'Lo·∫°i,Gi√°,Ng√†y c·∫≠p nh·∫≠t\n';
            if (portfolioData.marketPrices) {
                Object.keys(portfolioData.marketPrices).forEach(type => {
                    const data = portfolioData.marketPrices[type];
                    csv += `${type},${data.price},${data.updatedAt || ''}\n`;
                });
            }

            // Add monthly returns
            csv += '\nL·ª£i nhu·∫≠n theo th√°ng\n';
            csv += 'NƒÉm,Th√°ng,T·ª∑ su·∫•t (%)\n';
            Object.keys(portfolioData.monthlyReturns).forEach(year => {
                Object.keys(portfolioData.monthlyReturns[year]).forEach(month => {
                    csv += `${year},${month},${portfolioData.monthlyReturns[year][month]}\n`;
                });
            });

            // Add monthly snapshots
            csv += '\nCh·ªët gi√° tr·ªã theo th√°ng\n';
            csv += 'Th√°ng,Lo·∫°i t√†i s·∫£n,Gi√° tr·ªã,Gi√° v·ªën\n';
            if (portfolioData.monthlySnapshots) {
                Object.keys(portfolioData.monthlySnapshots).sort().forEach(monthKey => {
                    const snapshot = portfolioData.monthlySnapshots[monthKey];
                    Object.keys(snapshot).forEach(type => {
                        csv += `${monthKey},${type},${snapshot[type].value},${snapshot[type].cost}\n`;
                    });
                });
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ƒê√£ xu·∫•t file CSV!', 'success');
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    // Reset data
                    portfolioData.stocks = [];
                    portfolioData.otherAssets = [];
                    portfolioData.monthlySnapshots = {};
                    portfolioData.marketPrices = {};
                    
                    let currentSection = 'assets';
                    
                    lines.forEach((line, index) => {
                        if (index === 0) return; // Skip header
                        if (line.includes('Gi√° th·ªã tr∆∞·ªùng')) {
                            currentSection = 'marketPrices';
                            return;
                        }
                        if (line.includes('L·ª£i nhu·∫≠n theo th√°ng')) {
                            currentSection = 'monthly';
                            return;
                        }
                        if (line.includes('Ch·ªët gi√° tr·ªã theo th√°ng')) {
                            currentSection = 'snapshots';
                            return;
                        }
                        if (line.includes('NƒÉm,Th√°ng') || line.includes('Th√°ng,Lo·∫°i t√†i s·∫£n') || line.includes('Lo·∫°i,Gi√°,Ng√†y')) return; // Skip section headers
                        
                        const cols = line.split(',').map(c => c.trim());
                        if (cols.length < 2 || !cols[0]) return;

                        if (currentSection === 'marketPrices') {
                            const [type, price, updatedAt] = cols;
                            portfolioData.marketPrices[type] = {
                                price: parseFloat(price) || 0,
                                updatedAt: updatedAt || new Date().toISOString()
                            };
                        } else if (currentSection === 'monthly') {
                            const [year, month, rate] = cols;
                            if (!portfolioData.monthlyReturns[year]) {
                                portfolioData.monthlyReturns[year] = {};
                            }
                            portfolioData.monthlyReturns[year][month] = parseFloat(rate) || 0;
                        } else if (currentSection === 'snapshots') {
                            const [monthKey, type, value, cost] = cols;
                            if (!portfolioData.monthlySnapshots[monthKey]) {
                                portfolioData.monthlySnapshots[monthKey] = {};
                            }
                            portfolioData.monthlySnapshots[monthKey][type] = {
                                value: parseFloat(value) || 0,
                                cost: parseFloat(cost) || 0
                            };
                        } else {
                            const [type, nameOrCode, company, quantity, unit, costPrice, currentPrice, rate] = cols;
                            
                            if (type === 'stock') {
                                portfolioData.stocks.push({
                                    code: nameOrCode,
                                    company: company || '',
                                    quantity: parseInt(quantity) || 0,
                                    costPrice: parseFloat(costPrice) || 0,
                                    marketPrice: parseFloat(currentPrice) || 0
                                });
                            } else if (type === 'savings') {
                                portfolioData.otherAssets.push({
                                    type: 'savings',
                                    name: nameOrCode,
                                    amount: parseFloat(quantity) || 0,
                                    rate: parseFloat(rate) || 0,
                                    unit: 'VNƒê'
                                });
                            } else {
                                portfolioData.otherAssets.push({
                                    type: type,
                                    name: nameOrCode,
                                    quantity: parseFloat(quantity) || 0,
                                    unit: unit || '',
                                    costPrice: parseFloat(costPrice) || 0,
                                    currentPrice: parseFloat(currentPrice) || 0
                                });
                            }
                        }
                    });

                    saveData();
                    renderAll();
                    showToast('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                } catch (err) {
                    console.error(err);
                    showToast('L·ªói khi ƒë·ªçc file CSV!', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ============== UTILITIES ==============
        function formatVND(num) {
            if (num === undefined || num === null) return '0 ‚Ç´';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(num);
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
